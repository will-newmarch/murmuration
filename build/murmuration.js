var Murmuration=function(){"use strict";function g(t,i,s){void 0===i&&(i=0),void 0===s&&(s=0),this.x=t=void 0===t?0:t,this.y=i,this.z=s}g.prototype.getDistanceFrom=function(t){return Math.abs(Math.sqrt((this.x-t.x)*(this.x-t.x)+(this.y-t.y)*(this.y-t.y)+(this.z-t.z)*(this.z-t.z)))},g.prototype.getRoughDistanceFrom=function(t){t=[Math.abs(this.x-t.x),Math.abs(this.y-t.y),Math.abs(this.z-t.z)];return t[0]<t[1]&&t[0]<t[2]?t[0]:t[1]<t[0]&&t[1]<t[2]?t[1]:t[2]},g.prototype.getSpeed=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},g.prototype.normalise=function(){var t=this.getSpeed();this.x/=t,this.y/=t,this.z/=t},g.prototype.add=function(t){this.x+=t.x,this.y+=t.y,this.z+=t.z},g.prototype.multiply=function(t){this.x*=t,this.y*=t,this.z*=t},g.prototype.divide=function(t){this.x/=t,this.y/=t,this.z/=t},g.prototype.reset=function(){this.x*=0,this.y*=0,this.z*=0},g.prototype.toArray=function(){return[this.x,this.y,this.z]},g.prototype.toString=function(){return"<"+this.x+","+this.y+","+this.z+">"};function t(t){var i=this;Object.assign(this,{starlingCount:768,randomiseHome:!0,homeChangeInterval:4e3,neighbourDistance:160,worldWidth:1024,worldHeight:768,onUpdate:function(t){},homing:1,alignment:1,cohesion:1,separation:1},t),this.home=new g(this.worldWidth/2,this.worldHeight/2,1),this.randomiseHome&&this.changeHome(),this.starlings=[],this.homingMod=.2*.2,this.alignmentMod=.2*1.1,this.cohesionMod=.2*1.1,this.separationMod=.2*1.1;for(var s=0;s<this.starlingCount;s++){var h=Math.random(),e=Math.random(),o=2*h*Math.PI,a=Math.acos(2*e-1),n=Math.cbrt(Math.random()),h=Math.sin(o),e=Math.cos(o),o=Math.sin(a),a=Math.cos(a);this.addStarling(this.home.x+n*o*e*10,this.home.y+n*o*h*10,this.home.z+n*a*10)}this.randomiseHome&&(this.changeHomeFunc=function(){i.changeHome(),setTimeout(i.changeHomeFunc,i.homeChangeInterval)},this.changeHomeFunc()),this.averageDistance=new g,this.averagePosition=new g,this.averageVelocity=new g,this.homingVelocity=new g,this.neighbourCount=0,this.distances=[];for(var r=0;r<this.starlingCount;r++){this.distances.push([]);for(var l=0;l<this.starlingCount;l++)this.distances[r].push(0)}}var h=function(o){function t(t,i,s){o.call(this,t,i,s),this.zMod=.003,this.maxSpeed=3+Math.random();var h=Math.random(),e=Math.random(),t=2*h*Math.PI,i=Math.acos(2*e-1),s=Math.cbrt(Math.random()),h=Math.sin(t),e=Math.cos(t),t=Math.sin(i),i=Math.cos(i);this.velocity=new o(s*t*e,s*t*h,s*i),this.velocity.normalise(),this.skill=10+2*Math.random(),this.skillVariant=new o}return o&&(t.__proto__=o),((t.prototype=Object.create(o&&o.prototype)).constructor=t).prototype.update=function(){this.skillVariant.x=(Math.random()-.5)/this.skill,this.skillVariant.y=(Math.random()-.5)/this.skill,this.skillVariant.z=(Math.random()-.5)/this.skill,this.velocity.normalise(),this.velocity.multiply(this.maxSpeed),this.velocity.add(this.skillVariant),this.x+=this.velocity.x,this.y+=this.velocity.y,this.z+=this.velocity.z,this.skillVariant.reset()},t}(g);return t.prototype.addStarling=function(t,i,s){s=new h(t,i,s);this.starlings.push(s)},t.prototype.changeHome=function(){this.home.x=this.worldWidth/4+this.worldWidth*Math.random()/2,this.home.y=this.worldHeight/4+this.worldHeight*Math.random()/2,this.home.z=10*Math.random()},t.prototype.run=function(){var t=this;this.updateStarlings(),this.onUpdate(this.starlings),requestAnimationFrame(function(){return t.run()})},t.prototype.modifyStarling=function(t,i,s){for(var h=this.neighbourCount=0;h<this.starlingCount;h++)t!=this.starlings[h]&&s[i][h]<this.neighbourDistance&&(this.averageVelocity.x=this.starlings[h].velocity.x,this.averageVelocity.y=this.starlings[h].velocity.y,this.averageVelocity.z=this.starlings[h].velocity.z,this.averageDistance.x=this.starlings[h].x-t.x,this.averageDistance.y=this.starlings[h].y-t.y,this.averageDistance.z=this.starlings[h].z-t.z,this.neighbourCount++);this.averageVelocity.x/=this.neighbourCount,this.averageVelocity.y/=this.neighbourCount,this.averageVelocity.z/=this.neighbourCount,this.averageVelocity.normalise(),this.averageVelocity.multiply(this.alignmentMod),this.averageDistance.x/=this.neighbourCount,this.averageDistance.y/=this.neighbourCount,this.averageDistance.z/=this.neighbourCount,this.averageDistance.normalise(),this.averageDistance.multiply(this.cohesionMod),0<this.neighbourCount&&(t.velocity.add(this.averageVelocity),t.velocity.add(this.averageDistance)),this.averageDistance.divide(this.cohesionMod),this.averageDistance.multiply(this.separationMod),0<this.neighbourCount&&(t.velocity.x+=-1*this.averageDistance.x,t.velocity.y+=-1*this.averageDistance.y,t.velocity.z+=-1*this.averageDistance.z),this.averageVelocity.reset(),this.averageDistance.reset(),this.homingVelocity.x=this.home.x-t.x,this.homingVelocity.y=this.home.y-t.y,this.homingVelocity.z=this.home.z-t.z,this.homingVelocity.normalise(),this.homingVelocity.multiply(this.homingMod),t.velocity.add(this.homingVelocity),this.homingVelocity.reset()},t.prototype.updateStarlings=function(){for(var t=0;t<this.starlingCount;t++)for(var i=0;i<this.starlingCount;i++)this.distances[t][i]=this.starlings[t].getDistanceFrom(this.starlings[i]);for(var s=0;s<this.starlingCount;s++)this.averagePosition.x+=this.starlings[s].x,this.averagePosition.y+=this.starlings[s].y,this.averagePosition.z+=this.starlings[s].z;this.averagePosition.x/=this.starlings.length-1,this.averagePosition.y/=this.starlings.length-1,this.averagePosition.z/=this.starlings.length-1;for(var h=0;h<this.starlingCount;h++)this.modifyStarling(this.starlings[h],h,this.distances);this.averagePosition.reset();for(var e=0;e<this.starlingCount;e++)this.starlings[e].update()},t}();
